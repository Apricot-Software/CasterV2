<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="static/img/casterlogo.png">
    <meta name="viewport" content="width=device-width, initial-scale=2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@{{ handle }} on Caster</title>
    <meta property="og:title" content="{{ handle }} on Caster">
    <meta property="og:description" content="{{ postContent }}">
    <meta property="og:image" content="{{ pfp }}">
    <meta property="og:image:width" content="100" />
    <meta property="og:image:height" content="100" />
    <meta property="og:type" content="website">
    <link rel="stylesheet" href="static/style/style.css">
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <img src="static/img/casterlogo.png" width="50px">
        </div>
        <div class="content">
            <div class="left-bar">
                <a class="bar-button ab-text" onclick="window.location.href = '/'"><img src="static/img/home.png" class="bar-button-icon"><span class="bar-text">Home</span></a>
                <a class="bar-button ab-text" onclick="window.location.href = '/profile'"><img src="static/img/profile.png" class="bar-button-icon"><span class="bar-text">Profile</span></a>
                <a class="bar-button ab-text" onclick="window.location.href = '/search'"><img src="static/img/search.png" class="bar-button-icon"><span class="bar-text">Search</span></a>
                <a class="bar-button ab-text" onclick="window.location.href = '/create'"><img src="static/img/pencil.png" class="bar-button-icon"><span class="bar-text">Post</span></a>
                <a class="bar-button ab-text" onclick="window.location.href = '/settings'"><img src="static/img/settings.png" class="bar-button-icon"><span class="bar-text">Settings</span></a>
            </div>
            <div class="main-content" id="main-content" style="display: flex; flex-direction: column;">
                <div class="post-flex-box">
                    <div class="post-flex-box" id="reply-chain"></div>

                    <div class="poster-container" style="gap: 0;">
                        <img class="user-pfp" src="{{ user_pfp }}" style="margin: 0px;"><div id="post-input" class="post-input" placeholder="Say something..." oninput="if(this.innerHTML.trim()==='<br>')this.innerHTML=''" contentEditable></div><button class="positiveButton post-text" id="sendButton" onclick="sendPost()">Post</button>
                    </div>

                </div>
                <div class="post-flex-box" id="post-flex-box">
                </div>
                <div class="post-flex-box">
                    <div class="post-container">
                        <img class="user-pfp" src="static/img/placeholder.jpg">
                        <div style="width: calc(100% - 60px);">
                            <p class="user-bar">
                                <a class="display-name" href="/profile?user={{ handle }}"><img class="user-pfp" style="width: 400px; height: 10px" src="static/img/placeholder.jpg"></a>
                                <span class="handle"></span>
                            </p>
                            <p class="post-text"><img class="user-pfp" style="width: 400px; height: 10px" src="static/img/placeholder.jpg"><br><img class="user-pfp" style="width: 200px; height: 10px" src="static/img/placeholder.jpg"></p>
                            <div class="post-action-bar">
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="post-flex-box">
                    <div class="post-container">
                        <img class="user-pfp" src="static/img/placeholder.jpg">
                        <div style="width: calc(100% - 60px);">
                            <p class="user-bar">
                                <a class="display-name" href="/profile?user={{ handle }}"><img class="user-pfp" style="width: 400px; height: 10px" src="static/img/placeholder.jpg"></a>
                                <span class="handle"></span>
                            </p>
                            <p class="post-text"><img class="user-pfp" style="width: 400px; height: 10px" src="static/img/placeholder.jpg"><br><img class="user-pfp" style="width: 200px; height: 10px" src="static/img/placeholder.jpg"></p>
                            <div class="post-action-bar">
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="post-flex-box">
                    <div class="post-container">
                        <img class="user-pfp" src="static/img/placeholder.jpg">
                        <div style="width: calc(100% - 60px);">
                            <p class="user-bar">
                                <a class="display-name" href="/profile?user={{ handle }}"><img class="user-pfp" style="width: 400px; height: 10px" src="static/img/placeholder.jpg"></a>
                                <span class="handle"></span>
                            </p>
                            <p class="post-text"><img class="user-pfp" style="width: 400px; height: 10px" src="static/img/placeholder.jpg"><br><img class="user-pfp" style="width: 200px; height: 10px" src="static/img/placeholder.jpg"></p>
                            <div class="post-action-bar">
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="post-flex-box">
                    <div class="post-container">
                        <img class="user-pfp" src="static/img/placeholder.jpg">
                        <div style="width: calc(100% - 60px);">
                            <p class="user-bar">
                                <a class="display-name" href="/profile?user={{ handle }}"><img class="user-pfp" style="width: 400px; height: 10px" src="static/img/placeholder.jpg"></a>
                                <span class="handle"></span>
                            </p>
                            <p class="post-text"><img class="user-pfp" style="width: 400px; height: 10px" src="static/img/placeholder.jpg"><br><img class="user-pfp" style="width: 200px; height: 10px" src="static/img/placeholder.jpg"></p>
                            <div class="post-action-bar">
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                                <span>
                                    <img src="static/img/placeholder.jpg" class="like-icon" style="border-radius: 50px;">
                                    <a class="ab-text"></a>
                                </span>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="spacer"></div>
            </div>
            <div class="right-bar">
                <h1 style="padding-left: 25px">Relevent Users</h1>
                <div style="width: 300px" class="post-flex-box" id="reply-chain-users"></div>
            </div>
        </div>
    </div>
</body>
<script>
    function sendPost() {
    const postContent = document.getElementById('post-input').innerText;
    const sendButton = document.getElementById('sendButton');
    sendButton.className = "positiveButtonDisabled";
    sendButton.setAttribute("disabled", "");

    if (postContent === '') {
        alert('Post content cannot be empty.');
        sendButton.className = "positiveButton";
        sendButton.removeAttribute("disabled");
        return
    }

    fetch('/api/sendreplypost?refid={{ post_id }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: postContent })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
            window.location.href = '/login';
        }
        return response.json();
    })
    .then(data => {
        if (data.postId) {
            window.location.href = `/post?id=${data.postId}`;
        } else {
            console.error('Post ID not found in response');
        }
    })
}
function scrollToDiv(divId, containerId) {
    const targetDiv = document.getElementById(divId);
    const container = document.getElementById(containerId);

    if (targetDiv && container) {
        // Calculate the top position relative to the container
        const containerRect = container.getBoundingClientRect();
        const targetRect = targetDiv.getBoundingClientRect();

        // Adjust the scroll position within the container
        container.scrollTo({
            top: targetRect.top - containerRect.top + container.scrollTop,
            behavior: 'smooth'
        });
    } else {
        console.error(`Element with ID ${divId} or container with ID ${containerId} not found`);
    }
}
let currentPage = -1;
let isLoading = false;

function loadPosts() {
    if (isLoading) return;
    isLoading = true;

    currentPage++;
    fetch(`/api/replyposts?refid={{ post_id }}&page=${currentPage}`)
        .then(response => response.json())
        .then(posts => {
            const postsFlexBox = document.getElementById('post-flex-box');
            posts.forEach(post => {
                console.log('Post object:', post);
                const postContainer = document.createElement('div');
                postContainer.className = 'post-container';
                postContainer.onclick = function(){ window.location.href = `/post?id=${post.postId}`; };

                const userBar = document.createElement('p');
                const contentDiv = document.createElement('div')
                userBar.className = 'user-bar';
                contentDiv.style.width = "calc(100% - 60px)"
                contentDiv.appendChild(userBar);

                const userpfp = document.createElement('img');
                userpfp.src = post.pfp;
                userpfp.className = 'user-pfp';
                postContainer.appendChild(userpfp);

                const displayName = document.createElement('a');
                displayName.innerText = post.displayName;
                displayName.className = 'display-name';
                displayName.href = `/profile?user=${post.handle}`.replace('@', '')
                userBar.appendChild(displayName);

                if (post.isveri) {
                   const checkmark = document.createElement('img');
                   checkmark.src = 'static/img/veri.png';
                   checkmark.style.width = '15px';
                   userBar.appendChild(checkmark);
                };


                const handle = document.createElement('span');
                handle.innerText = `${post.handle} • ${post.timestamp}`;
                handle.className = 'handle';
                userBar.appendChild(handle);
                postContainer.appendChild(contentDiv);

                const postContent = document.createElement('p');
                postContent.innerHTML = `${post.postContent}`;
                postContent.className = 'post-text';
                contentDiv.appendChild(postContent);


                const videoPlayer = document.createElement('div');
                console.log("Loading video player for video ID:", post.videoId);
                videoPlayer.innerHTML = `<iframe frameborder="0" src="/iframe/videoplayer?vid=${post.videoId}"></iframe>`;
                contentDiv.appendChild(videoPlayer);

                const actionBar = document.createElement('div');
                actionBar.className = 'post-action-bar';
                contentDiv.appendChild(actionBar);

                // Like action
                const likeContainer = document.createElement('span');
                actionBar.appendChild(likeContainer);

                const likeIcon = document.createElement('img');
                likeIcon.src = 'static/img/like-unselect.png';
                likeIcon.className = 'like-icon';
                likeContainer.appendChild(likeIcon);

                const likeCounter = document.createElement('a');
                likeCounter.innerText = post.likes || '0';
                likeCounter.className = 'ab-text';
                likeContainer.appendChild(likeCounter);

                // Comment action
                const commentContainer = document.createElement('span');
                actionBar.appendChild(commentContainer);

                const commentIcon = document.createElement('img');
                commentIcon.src = 'static/img/message.png';
                commentIcon.className = 'like-icon';
                commentContainer.appendChild(commentIcon);

                const commentCounter = document.createElement('a');
                commentCounter.innerText = post.replys || '0';
                commentCounter.className = 'ab-text';
                commentContainer.appendChild(commentCounter);

                // Share action
                const shareContainer = document.createElement('span');
                actionBar.appendChild(shareContainer);

                const shareIcon = document.createElement('img');
                shareIcon.src = 'static/img/share.png';
                shareIcon.className = 'like-icon';
                shareContainer.appendChild(shareIcon);

                const shareCounter = document.createElement('a');
                shareCounter.innerText = post.shares || '0';
                shareCounter.className = 'ab-text';
                shareContainer.appendChild(shareCounter);

                postsFlexBox.appendChild(postContainer);
            });

            isLoading = false;

        })
        .catch(error => console.error('Error fetching data:', error));
}
function loadReplyChainUsers() {
    fetch(`/api/replychain/users?id={{ post_id }}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(users => {
            const postsFlexBox = document.getElementById('reply-chain-users');
            if (!postsFlexBox) {
                console.error('Element with ID reply-chain-users not found. lime messed something up again.');
                return;
            }

            postsFlexBox.innerHTML = ''; // Clear any existing content

            users.forEach((user, index) => {
                const userContainer = document.createElement('div');
                userContainer.className = 'post-container';
                userContainer.style.border = "none";
                userContainer.style.paddingTop = "0px";
                userContainer.style.paddingBottom = "0px";
                userContainer.onclick = function() { window.location.href = `/profile?user=${user.handle}`.replace('@', ''); };

                const userBar = document.createElement('p');
                userBar.className = 'user-bar';

                const userPfp = document.createElement('img');
                userPfp.src = user.pfp;
                userPfp.className = 'user-pfp';
                userContainer.appendChild(userPfp);

                const contentDiv = document.createElement('div');
                contentDiv.style.width = "calc(100% - 60px)";
                userContainer.appendChild(contentDiv);
                contentDiv.appendChild(userBar);

                const displayName = document.createElement('a');
                displayName.innerText = user.displayName;
                displayName.className = 'display-name';
                displayName.href = `/profile?user=${user.handle}`;
                userBar.appendChild(displayName);

                if (user.isveri) {
                   const checkmark = document.createElement('img');
                   checkmark.src = 'static/img/veri.png';
                   checkmark.style.width = '15px';
                   userBar.appendChild(checkmark);
                };

                const userHandle = document.createElement('span');
                userHandle.innerText = user.handle;
                userHandle.className = 'handle';
                userBar.appendChild(userHandle);

                const userBio = document.createElement('p');
                userBio.innerHTML = user.bio;
                userBio.className = 'post-text';
                contentDiv.appendChild(userBio);

                postsFlexBox.appendChild(userContainer);
            });
        })
        .catch(error => console.error('Error fetching data:', error));
}
function loadReplyChain() {
    let viewPostId;

    currentPage++;
    fetch(`/api/replychain?id={{ post_id }}`)
        .then(response => response.json())
        .then(posts => {
            const postsFlexBox = document.getElementById('reply-chain');
            posts.forEach((post, index) => {
                const postContainer = document.createElement('div');
                postContainer.className = 'post-container';
                postContainer.id = `post-${post.postId}`;
                if (index < posts.length - 1) {
                    postContainer.style.border = "none";
                } else {
                    viewPostId = `post-${post.postId}`;
                }
                postContainer.onclick = function(){ window.location.href = `/post?id=${post.postId}`; };

                const userBar = document.createElement('p');
                const contentDiv = document.createElement('div')
                contentDiv.style.width = "calc(100% - 60px)"
                userBar.className = 'user-bar';
                contentDiv.appendChild(userBar);

                const userpfp = document.createElement('img');
                userpfp.src = post.pfp;
                userpfp.className = 'user-pfp';
                postContainer.appendChild(userpfp);

                if (index < posts.length - 1) {
                    const postconline = document.createElement('hr');
                    postContainer.appendChild(postconline);
                }

                const displayName = document.createElement('a');
                displayName.innerText = post.displayName;
                displayName.className = 'display-name';
                displayName.href = `/profile?user=${post.handle}`.replace('@', '')
                userBar.appendChild(displayName);

                if (post.isveri) {
                   const checkmark = document.createElement('img');
                   checkmark.src = 'static/img/veri.png';
                   checkmark.style.width = '15px';
                   userBar.appendChild(checkmark);
                };


                const handle = document.createElement('span');
                handle.innerText = `${post.handle} • ${post.timestamp}`;
                handle.className = 'handle';
                userBar.appendChild(handle);
                postContainer.appendChild(contentDiv);

                const postContent = document.createElement('p');
                postContent.innerHTML = `${post.postContent}`;
                postContent.className = 'post-text';
                contentDiv.appendChild(postContent);

                console.log(post.videoId);

                if (post.videoId !== "None") {
                    const videoPlayer = document.createElement('div');
                    console.log("Loading video player for video ID:", post.videoId);
                    videoPlayer.className = 'player-container'
                    videoPlayer.innerHTML = `<iframe frameborder="0" src="/iframe/videoplayer?vid=${post.videoId}"></iframe>`;
                    contentDiv.appendChild(videoPlayer);
                }

                const actionBar = document.createElement('div');
                actionBar.className = 'post-action-bar';
                contentDiv.appendChild(actionBar);

                // Like action
                const likeContainer = document.createElement('span');
                actionBar.appendChild(likeContainer);

                const likeIcon = document.createElement('img');
                likeIcon.src = 'static/img/like-unselect.png';
                likeIcon.className = 'like-icon';
                likeContainer.appendChild(likeIcon);

                const likeCounter = document.createElement('a');
                likeCounter.innerText = post.likes || '0';
                likeCounter.className = 'ab-text';
                likeContainer.appendChild(likeCounter);

                // Comment action
                const commentContainer = document.createElement('span');
                actionBar.appendChild(commentContainer);

                const commentIcon = document.createElement('img');
                commentIcon.src = 'static/img/message.png';
                commentIcon.className = 'like-icon';
                commentContainer.appendChild(commentIcon);

                const commentCounter = document.createElement('a');
                commentCounter.innerText = post.replys || '0';
                commentCounter.className = 'ab-text';
                commentContainer.appendChild(commentCounter);

                // Share action
                const shareContainer = document.createElement('span');
                actionBar.appendChild(shareContainer);

                const shareIcon = document.createElement('img');
                shareIcon.src = 'static/img/share.png';
                shareIcon.className = 'like-icon';
                shareContainer.appendChild(shareIcon);

                const shareCounter = document.createElement('a');
                shareCounter.innerText = post.shares || '0';
                shareCounter.className = 'ab-text';
                shareContainer.appendChild(shareCounter);

                const postID = document.createElement('div');
                postID.innerHTML = `pid: ${post.postId}`;
                postID.className = 'post-text';
                postID.onclick = function() { navigator.clipboard.writeText(text).then(() => { console.log('Text copied to clipboard'); }).catch(err => { console.error('Failed to copy text: ', err); }); };
                postID.style.zindex = "70";
                contentDiv.appendChild(postID);

                postsFlexBox.appendChild(postContainer);
            });

            if (viewPostId) {
                scrollToDiv(viewPostId, 'main-content');
            }

        })
        .catch(error => console.error('Error fetching data:', error));

}
    document.addEventListener('DOMContentLoaded',() => {
        loadPosts();
        loadReplyChainUsers();
        loadReplyChain();


    });

    const mainContent = document.querySelector('.main-content');


    mainContent.addEventListener('scroll', function() {
        if (mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 1700) {
            console.log(mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 100);
            loadPosts();
        }
    });
document.getElementById('post-input').addEventListener('paste', function(event) {
    event.preventDefault();

    // Get the pasted content from clipboard
    const clipboardData = event.clipboardData || window.clipboardData;
    let pastedData = clipboardData.getData('text');

    // Optionally, you can use HTML if you want to keep plain text and remove HTML formatting
    // let pastedData = clipboardData.getData('text/html') || clipboardData.getData('text');

    // Insert the cleaned text
    document.execCommand('insertHTML', false, pastedData);
});
</script>
</html>
